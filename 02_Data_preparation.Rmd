# Data preparation

## Datasets

```{r}
library(knitr)
library(tidyr)
library(dplyr)
library(countrycode)
```

### Academic ranking of world universities (Shanghai ranking)

According to their website, the Academic Ranking of World Universities (ARWU) is recognized as the precursor of global university rankings and the most trustworthy one. ARWU presents the world's top 1000 research universities annually based on transparent methodology and objective third-party data.

- Name: Academic Ranking of World Universities (ARWU) - Shanghai Rankings from 2005-2018
- Website: https://www.shanghairanking.com/
- Dataset: https://www.kaggle.com/datasets/joebeachcapital/shanghai-world-university-ranking

The dataset contains a row per university and year, assigning a rank to each university based on various indicators:

- Quality of Education, with Alumni and Award indicators (10% and 20% of the final mark)
- Quality of Faculty, with HiCi and N&S indicators (20% and 20% of the final mark)
- Research Output, with PUB indicator (20% of the final mark)
- Per Capita Performance, with PCP indicator (10% of the final mark)

More on the methodology and definitions of the indicators can be found on their [methodology website](https://www.shanghairanking.com/methodology/arwu/2023). The structure of the dataset looks like this (indicators and ISO country codes are ommitted):

```{r results = TRUE}
df_uni <- read.csv('data/shanghai-world-university-ranking.csv',
                   sep = ';',
                   na = "")
# Remove unnecessary columns
df_uni <- df_uni %>% select(-c(Geo.Shape))

# Rename columns
df_uni <- df_uni %>% rename("Rank" = "World.rank.integer")

kable(head(df_uni %>% select(c("World.rank", "Rank", "Year", "University", "Country")), 10))
```
```{r}
str(df_uni)
```
### Economic dataset

todo

### Human Development Index (HDI)

The Human Development Index (HDI) was created to emphasize that people and their capabilities should be the ultimate criteria for assessing the development of a country, not economic growth alone. The HDI is a summary measure of average achievement in key dimensions of human development: a long and healthy life, being knowledgeable and having a decent standard of living. The health dimension is assessed by life expectancy at birth, the education dimension is measured by mean of years of schooling for adults aged 25 years and more and expected years of schooling for children of school entering age. The standard of living dimension is measured by gross national income per capita.

- Name: Human Development Index (HDI)
- Website: https://hdr.undp.org/data-center/human-development-index
- Dataset: https://hdr.undp.org/sites/default/files/2021-22_HDR/HDR21-22_Composite_indices_complete_time_series.csv
- Metadata: https://hdr.undp.org/sites/default/files/2021-22_HDR/HDR21-22_Composite_indices_metadata.xlsx

The dataset is in wide format, containing a row for each of the 206 countries and a column for each indicator-year combination. The time span ranges from 1990-2021 for most indicators, resulting in 1008 columns total. The structure looks like this (only a selected few indicator-year columns are shown):

```{r results = TRUE}
df_hdi <- read.csv('data/HDR21-22_Composite_indices_complete_time_series.csv', sep = ',')

kable(head(df_hdi %>% select(c(iso3, country, hdicode, hdi_1990, hdi_2021, le_1990, le_2021)), 10))
```
## Preprocessing

```{r}
# Validate the total score.
Total_score <- function(df) {
  score <- df$Alumni*0.1 + df$Award*0.2 + df$Hi.Ci*0.2 + df$N.S*0.2 + df$PUB*0.2 + df$PCP*0.1
  return(score)
}

df_uni$Total_score <- Total_score(df_uni)
```

### Univerity rank aggregation

In order to correlate the university rankings with economic and human development over time, we aggregated the university rankings per country and year. First, we assigned a score per university based on its rank according to an exponential decay model. The idea is to score top universities a lot higher and introduce an exponential decay in score for lower ranks. This approach was inspired by [webometrics](https://www.webometrics.info/en/distribution_by_country), which orders countries by the number of universities in top categories first.

```{r results = TRUE}
# University rank scoring parameters
lambda <- 0.01  # Decay constant
ranks <- seq(1, 500, by=1)
max_score <- 100
base_score <- 10

# Exponential decay function
scores <- round((max_score - base_score) * exp(-lambda * ranks) + base_score)

# Assign to dataframe
df_uni$Points <- as.integer(round((max_score - base_score) * exp(-lambda * df_uni$Rank ) + base_score))

# Plot
plot(ranks, scores, type='l', main="Exponential decay of rank score",
     xlab="Rank", ylab="Score", ylim = c(0, 100))
grid(nx = NA, ny = NULL, lty = 2, col = "gray", lwd = 1)
```

Once every university was assigned a score per year based on its rank, the scores were summed up and the universities counted per country and year. The aggregation resulted in the following structure, ready to be joined with the economic and HDI datasets:
```{r results = TRUE}
# Aggregate university ranks per country per year
df_uni_agg <- df_uni %>%
    group_by(ISO3.CODE, Country, Year) %>%
    summarise(Points = sum(Points), Count = n()) %>%
    na.omit()

kable(head(df_uni_agg %>% filter(ISO3.CODE == 'USA'), 5))
```

### Economic dataset

todo

### HDI dataset

From the Human Development Index (HDI) dataset, the timelines of the following indicators of interest were picked:

- Human Development Index -- a summary of a long and healthy life, access to knowledge and a decent standard of living.
- Life expectancy at birth
- Expected years of schooling
- Mean years of schooling
- Gross National Income (GNI) per capita
- Gender Development Index (GDI) -- measures gender inequalities in achievement in three basic dimensions of human development:
  - health, measured by female and male life expectancy at birth
  - education, measured by female and male expected years of schooling for children and female and male mean years of schooling for adults ages 25 years and older
  - command over economic resources, measured by female and male estimated earned income
- Gender Inequality Index (GII) -- reflects gender-based disadvantage in three dimensions for as many countries as data of reasonable quality allow:
  - reproductive health
  - empowerment
  - labourmarket

For details on the indicators, see the [technical notes](https://hdr.undp.org/sites/default/files/2021-22_HDR/hdr2021-22_technical_notes.pdf).
```{r}
# Select indicators from the HDI group only
hdi_year_columns <- paste0(
    "^", c("hdi", "le", "eys", "mys", "gnipc", "gdi", "gii"), "_\\d{4}$")
df_hdi <- df_hdi %>%
    select(iso3, country, hdicode, hdi_rank_2021, matches(hdi_year_columns))
```


```{r}
df_hdi_long <- pivot_longer(
    df_hdi,
    cols = -c(iso3, country, hdicode, hdi_rank_2021),
    names_to = "feature",
    values_to = "value")
```
```{r}
# Split feature into indicator and year columns by using only the last separator
df_hdi_long <- df_hdi_long %>%
    separate(feature, into = c("indicator", "year"), sep = "_(?=[^_]+$)", extra = "merge")
df_hdi_long$year <- as.integer(df_hdi_long$year)
```

```{r}
# Transform back to wide format with a column per indicator, but country and year as rows
df_hdi <- pivot_wider(
    df_hdi_long, names_from = "indicator", values_from = "value")
```
```{r}
df_hdi <- left_join(
    df_hdi, df_uni_agg, by = c("year" = "Year", "iso3" = "ISO3.CODE"))

df_hdi <- df_hdi %>%
    select(-Country) %>%
    rename(uni_score = Points, uni_count = Count)
```


```{r}
df_hdi <- df_hdi %>%
    mutate(
        region = countrycode(df_hdi$iso3, origin = "iso3c", destination = "region"),
        continent = countrycode(df_hdi$iso3, origin = "iso3c", destination = "continent"),
        .after = 'country'
    )
```

The dataset was transformed into a suitable format, containing a row per country and year, and columns for the indicators. After joining the transformed HDI dataset with the previously prepared university ranking data, world region and continent information was added as well. This is the structure of the final dataset:

```{r results = TRUE}
kable(df_hdi %>%
    mutate(across(is.numeric, round, digits=2)) %>%
    select(c(country, continent, year, hdi, le, eys, mys, gnipc, gdi, gii, uni_score, uni_count)) %>%
    filter(country == 'Germany' & year >= 2005) %>%
    head(5)
)
```

```{r}
write.csv(df_hdi, 'app_data/hdi.csv')
```

